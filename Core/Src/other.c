//
// Created by lxcy on 2025/11/30.
//
#include "other.h"
// 正弦查表 1024分辨率,代表0~PI/2
// 其中0~PI/2使用R4表示，正弦值使用R0表示
// 将theta(0~PI/2) (0~210828719,注意这里是210828720-1,原因见Q_sin_cos代码)
// 将0~210828719映射到 (0~1023) 将 102943 / 206,088.68 约等于 1023
// 或将 210828719 * 5 / 1,030,443 (整数计算) 约等于 1023 (截尾)
constexpr R0_t sinTable[1024]={{0},{3294197},{6588387},{9882561},{13176712},{16470832},{19764913},{23058947},{26352928},{29646846},{32940695},{36234466},{39528151},{42821744},{46115236},{49408620},{52701887},{55995030},{59288042},{62580914},{65873638},{69166208},{72458615},{75750851},{79042909},{82334782},{85626460},{88917937},{92209205},{95500255},{98791081},{102081675},{105372028},{108662134},{111951983},{115241570},{118530885},{121819921},{125108670},{128397125},{131685278},{134973122},{138260647},{141547847},{144834714},{148121241},{151407418},{154693240},{157978697},{161263783},{164548489},{167832808},{171116733},{174400254},{177683365},{180966058},{184248325},{187530159},{190811551},{194092495},{197372981},{200653003},{203932553},{207211624},{210490206},{213768293},{217045878},{220322951},{223599506},{226875535},{230151030},{233425984},{236700388},{239974235},{243247518},{246520228},{249792358},{253063900},{256334847},{259605191},{262874923},{266144038},{269412525},{272680379},{275947592},{279214155},{282480061},{285745302},{289009871},{292273760},{295536961},{298799466},{302061269},{305322361},{308582734},{311842381},{315101295},{318359466},{321616889},{324873555},{328129457},
{331384586},{334638936},{337892498},{341145265},{344397230},{347648383},{350898719},{354148230},{357396906},{360644742},{363891730},{367137861},{370383128},{373627523},{376871039},{380113669},{383355404},{386596237},{389836160},{393075166},{396313247},{399550396},{402786604},{406021865},{409256170},{412489512},{415721883},{418953276},{422183684},{425413098},{428641511},{431868915},{435095303},{438320667},{441545000},{444768294},{447990541},{451211734},{454431865},{457650927},{460868912},{464085813},{467301622},{470516330},{473729932},{476942419},{480153784},{483364019},{486573117},{489781069},{492987869},{496193509},{499397982},{502601279},{505803394},{509004318},{512204045},{515402566},{518599875},{521795963},{524990824},{528184449},{531376831},{534567963},{537757837},{540946445},{544133781},{547319836},{550504604},{553688076},{556870245},{560051104},{563230645},{566408860},{569585743},{572761285},{575935480},{579108320},{582279796},{585449903},{588618632},{591785976},{594951927},{598116479},{601279623},{604441352},{607601658},{610760536},{613917975},{617073971},{620228514},{623381598},{626533215},{629683357},{632832018},{635979190},{639124865},{642269036},{645411696},{648552838},
{651692453},{654830535},{657967075},{661102068},{664235505},{667367379},{670497682},{673626408},{676753549},{679879097},{683003045},{686125387},{689246113},{692365218},{695482694},{698598533},{701712728},{704825272},{707936158},{711045377},{714152924},{717258790},{720362968},{723465451},{726566232},{729665303},{732762657},{735858287},{738952186},{742044345},{745134758},{748223418},{751310318},{754395449},{757478806},{760560380},{763640164},{766718151},{769794334},{772868706},{775941259},{779011986},{782080880},{785147934},{788213141},{791276492},{794337982},{797397602},{800455346},{803511207},{806565177},{809617249},{812667415},{815715670},{818762005},{821806413},{824848888},{827889422},{830928007},{833964638},{836999305},{840032004},{843062726},{846091463},{849118210},{852142959},{855165703},{858186435},{861205147},{864221832},{867236484},{870249095},{873259659},{876268167},{879274614},{882278992},{885281293},{888281512},{891279640},{894275671},{897269597},{900261413},{903251110},{906238681},{909224120},{912207419},{915188572},{918167572},{921144411},{924119082},{927091579},{930061894},{933030021},{935995952},{938959681},{941921200},{944880503},{947837582},{950792431},{953745043},
{956695411},{959643527},{962589385},{965532978},{968474300},{971413342},{974350098},{977284562},{980216726},{983146583},{986074127},{988999351},{991922248},{994842810},{997761031},{1000676905},{1003590424},{1006501581},{1009410370},{1012316784},{1015220816},{1018122458},{1021021705},{1023918550},{1026812985},{1029705004},{1032594600},{1035481766},{1038366495},{1041248781},{1044128617},{1047005996},{1049880912},{1052753357},{1055623324},{1058490808},{1061355801},{1064218296},{1067078288},{1069935768},{1072790730},{1075643169},{1078493076},{1081340445},{1084185270},{1087027544},{1089867259},{1092704411},{1095538991},{1098370993},{1101200410},{1104027237},{1106851465},{1109673089},{1112492101},{1115308496},{1118122267},{1120933406},{1123741908},{1126547765},{1129350972},{1132151521},{1134949406},{1137744621},{1140537158},{1143327011},{1146114174},{1148898640},{1151680403},{1154459456},{1157235792},{1160009405},{1162780288},{1165548435},{1168313840},{1171076495},{1173836395},{1176593533},{1179347902},{1182099496},{1184848308},{1187594332},{1190337562},{1193077991},{1195815612},{1198550419},{1201282407},{1204011567},{1206737894},{1209461382},{1212182024},{1214899813},{1217614743},{1220326809},{1223036002},{1225742318},{1228445750},{1231146291},{1233843935},{1236538675},
{1239230506},{1241919421},{1244605414},{1247288478},{1249968606},{1252645794},{1255320034},{1257991320},{1260659646},{1263325005},{1265987392},{1268646800},{1271303222},{1273956653},{1276607086},{1279254516},{1281898935},{1284540337},{1287178717},{1289814068},{1292446384},{1295075659},{1297701886},{1300325060},{1302945174},{1305562222},{1308176198},{1310787095},{1313394909},{1315999631},{1318601257},{1321199781},{1323795195},{1326387494},{1328976672},{1331562723},{1334145641},{1336725419},{1339302052},{1341875533},{1344445857},{1347013017},{1349577007},{1352137822},{1354695455},{1357249901},{1359801152},{1362349204},{1364894050},{1367435685},{1369974101},{1372509294},{1375041258},{1377569986},{1380095472},{1382617710},{1385136696},{1387652422},{1390164882},{1392674072},{1395179984},{1397682613},{1400181954},{1402678000},{1405170745},{1407660183},{1410146309},{1412629117},{1415108601},{1417584755},{1420057574},{1422527051},{1424993180},{1427455956},{1429915374},{1432371426},{1434824109},{1437273414},{1439719338},{1442161874},{1444601017},{1447036760},{1449469098},{1451898025},{1454323536},{1456745625},{1459164286},{1461579514},{1463991302},{1466399645},{1468804538},{1471205974},{1473603949},{1475998456},{1478389489},{1480777044},{1483161115},{1485541696},{1487918781},{1490292364},
{1492662441},{1495029006},{1497392053},{1499751576},{1502107570},{1504460029},{1506808949},{1509154322},{1511496145},{1513834411},{1516169114},{1518500250},{1520827813},{1523151797},{1525472197},{1527789007},{1530102222},{1532411837},{1534717846},{1537020244},{1539319024},{1541614183},{1543905714},{1546193612},{1548477872},{1550758488},{1553035455},{1555308768},{1557578421},{1559844408},{1562106725},{1564365367},{1566620327},{1568871601},{1571119183},{1573363068},{1575603251},{1577839726},{1580072489},{1582301533},{1584526854},{1586748447},{1588966306},{1591180426},{1593390801},{1595597428},{1597800299},{1599999411},{1602194758},{1604386335},{1606574136},{1608758157},{1610938393},{1613114838},{1615287487},{1617456335},{1619621377},{1621782608},{1623940023},{1626093616},{1628243383},{1630389319},{1632531418},{1634669676},{1636804087},{1638934646},{1641061349},{1643184191},{1645303166},{1647418269},{1649529496},{1651636841},{1653740300},{1655839867},{1657935539},{1660027308},{1662115172},{1664199124},{1666279161},{1668355276},{1670427466},{1672495725},{1674560049},{1676620432},{1678676870},{1680729357},{1682777890},{1684822463},{1686863072},{1688899711},{1690932376},{1692961062},{1694985765},{1697006479},{1699023199},{1701035922},{1703044642},{1705049355},{1707050055},{1709046739},
{1711039401},{1713028037},{1715012642},{1716993211},{1718969740},{1720942225},{1722910659},{1724875040},{1726835361},{1728791620},{1730743810},{1732691928},{1734635968},{1736575927},{1738511799},{1740443581},{1742371267},{1744294853},{1746214334},{1748129707},{1750040966},{1751948107},{1753851126},{1755750017},{1757644777},{1759535401},{1761421885},{1763304224},{1765182414},{1767056450},{1768926328},{1770792044},{1772653593},{1774510970},{1776364172},{1778213194},{1780058032},{1781898681},{1783735137},{1785567396},{1787395453},{1789219305},{1791038946},{1792854372},{1794665580},{1796472565},{1798275323},{1800073849},{1801868139},{1803658189},{1805443995},{1807225553},{1809002858},{1810775906},{1812544694},{1814309216},{1816069469},{1817825449},{1819577151},{1821324572},{1823067707},{1824806552},{1826541103},{1828271356},{1829997307},{1831718951},{1833436286},{1835149306},{1836858008},{1838562388},{1840262441},{1841958164},{1843649553},{1845336604},{1847019312},{1848697674},{1850371686},{1852041343},{1853706643},{1855367581},{1857024153},{1858676355},{1860324183},{1861967634},{1863606704},{1865241388},{1866871683},{1868497586},{1870119091},{1871736196},{1873348897},{1874957189},{1876561070},{1878160535},{1879755580},{1881346202},{1882932397},{1884514161},{1886091491},{1887664383},
{1889232832},{1890796837},{1892356392},{1893911494},{1895462140},{1897008325},{1898550047},{1900087301},{1901620084},{1903148392},{1904672222},{1906191570},{1907706433},{1909216806},{1910722688},{1912224073},{1913720958},{1915213340},{1916701216},{1918184581},{1919663432},{1921137767},{1922607581},{1924072871},{1925533633},{1926989864},{1928441561},{1929888720},{1931331338},{1932769411},{1934202936},{1935631910},{1937056329},{1938476190},{1939891490},{1941302225},{1942708392},{1944109987},{1945507008},{1946899451},{1948287312},{1949670589},{1951049279},{1952423377},{1953792881},{1955157788},{1956518093},{1957873796},{1959224890},{1960571375},{1961913246},{1963250501},{1964583136},{1965911148},{1967234535},{1968553292},{1969867417},{1971176906},{1972481757},{1973781967},{1975077532},{1976368450},{1977654717},{1978936331},{1980213288},{1981485585},{1982753220},{1984016189},{1985274489},{1986528118},{1987777073},{1989021350},{1990260946},{1991495860},{1992726087},{1993951625},{1995172471},{1996388622},{1997600076},{1998806829},{2000008879},{2001206222},{2002398857},{2003586779},{2004769987},{2005948478},{2007122248},{2008291295},{2009455617},{2010615210},{2011770073},{2012920201},{2014065592},{2015206245},{2016342155},{2017473321},{2018599739},{2019721407},{2020838323},{2021950484},
{2023057887},{2024160529},{2025258408},{2026351522},{2027439867},{2028523442},{2029602243},{2030676269},{2031745516},{2032809982},{2033869665},{2034924562},{2035974670},{2037019988},{2038060512},{2039096241},{2040127172},{2041153301},{2042174628},{2043191150},{2044202863},{2045209767},{2046211857},{2047209133},{2048201592},{2049189231},{2050172048},{2051150040},{2052123207},{2053091544},{2054055050},{2055013723},{2055967560},{2056916560},{2057860719},{2058800036},{2059734508},{2060664133},{2061588910},{2062508835},{2063423908},{2064334124},{2065239484},{2066139983},{2067035621},{2067926394},{2068812302},{2069693342},{2070569511},{2071440808},{2072307231},{2073168777},{2074025446},{2074877233},{2075724139},{2076566160},{2077403294},{2078235540},{2079062896},{2079885360},{2080702930},{2081515603},{2082323379},{2083126254},{2083924228},{2084717298},{2085505463},{2086288720},{2087067068},{2087840505},{2088609029},{2089372638},{2090131331},{2090885105},{2091633960},{2092377892},{2093116901},{2093850985},{2094580142},{2095304370},{2096023667},{2096738032},{2097447464},{2098151960},{2098851519},{2099546139},{2100235819},{2100920556},{2101600350},{2102275199},{2102945101},{2103610054},{2104270057},{2104925109},{2105575208},{2106220352},{2106860540},{2107495770},{2108126041},{2108751352},
{2109371700},{2109987085},{2110597505},{2111202959},{2111803444},{2112398960},{2112989506},{2113575080},{2114155680},{2114731305},{2115301954},{2115867626},{2116428319},{2116984031},{2117534762},{2118080511},{2118621275},{2119157054},{2119687847},{2120213651},{2120734467},{2121250292},{2121761126},{2122266967},{2122767814},{2123263666},{2123754522},{2124240380},{2124721240},{2125197100},{2125667960},{2126133817},{2126594672},{2127050522},{2127501367},{2127947206},{2128388038},{2128823862},{2129254676},{2129680480},{2130101272},{2130517052},{2130927819},{2131333572},{2131734309},{2132130030},{2132520734},{2132906420},{2133287087},{2133662734},{2134033361},{2134398966},{2134759548},{2135115107},{2135465642},{2135811153},{2136151637},{2136487095},{2136817525},{2137142927},{2137463301},{2137778644},{2138088958},{2138394240},{2138694490},{2138989708},{2139279892},{2139565043},{2139845159},{2140120240},{2140390284},{2140655293},{2140915264},{2141170197},{2141420092},{2141664948},{2141904764},{2142139541},{2142369276},{2142593971},{2142813624},{2143028234},{2143237802},{2143442326},{2143641807},{2143836244},{2144025635},{2144209982},{2144389283},{2144563539},{2144732748},{2144896910},{2145056025},{2145210092},{2145359112},{2145503083},{2145642006},{2145775880},{2145904705},{2146028480},
{2146147205},{2146260881},{2146369505},{2146473080},{2146571603},{2146665076},{2146753497},{2146836866},{2146915184},{2146988450},{2147056664},{2147119825},{2147177934},{2147230991},{2147278995},{2147321946},{2147359845},{2147392690},{2147420483},{2147443222},{2147460908},{2147473542},{2147481121}
};

// 求正弦值和余弦值(查表法，实测误差<0.002f)
void R4_sin_cos(R4_t theta,R0_t *sinTheta,R0_t *cosTheta) {
    //归一化到0~2PI
    while (theta.value >= PI2_R4.value) theta.value -= PI2_R4.value;
    while (theta.value < 0)theta.value += PI2_R4.value;
    //归一化到PI/2，并且记录它是哪个象限的
    int Quadrant = 0; //0~3分别代表1~4象限
    while (theta.value > PIdiv2_R4.value) {
        Quadrant++;
        theta.value -= PIdiv2_R4.value;
    }
    //归一化到0~1023(PIdiv2_R4.value=210828720,210828729*5/1030443=1023)
    const uint32_t t=theta.value*5/1030443;
    switch (Quadrant) {
        // 以下代码注释中 tx 表示 t 未归一化到0~PI/2的原始值
        case 0:
            //第一象限 t=tx , sin(tx)=sinTable[t] , cos(tx)=sinTable[1023-t]
            sinTheta->value=sinTable[t].value;
            cosTheta->value=sinTable[1023-t].value;
            break;
        case 1:
            //第二象限 t=tx-PI/2
            //sin(tx)=sin(t+PI/2)=cos(t)=sinTable[1023-t]
            //cos(tx)=cos(t+PI/2)=-sin(t)=-sinTable[t]
            sinTheta->value=sinTable[1023-t].value;
            cosTheta->value=-sinTable[t].value;
            break;
        case 2:
            //第三象限 t=tx-PI
            //sin(tx)=sin(t+PI)=-sin(t)=-sinTable[t]
            //cos(tx)=cos(t+PI)=-cos(t)=-sinTable[1023-t]
            sinTheta->value=-sinTable[t].value;
            cosTheta->value=-sinTable[1023-t].value;
            break;
        case 3:
            //第四象限 t=tx-3PI/2
            //sin(tx)=sin(t+3PI/2)=-cos(t)=-sinTable[1023-t]
            //cos(tx)=cos(t+3PI/2)=sin(t)=sinTable[t]
            sinTheta->value=-sinTable[1023-t].value;
            cosTheta->value=sinTable[t].value;
            break;
        default:
            break;
    }
}

// 自动生成两个电流的5点中值滤波函数
GenerateFunction_MedianFilter5(Ia)
GenerateFunction_MedianFilter5(Ib)